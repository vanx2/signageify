<!DOCTYPE html>
<html>
  <head>
<style type="text/css">
  body { background-color: black; margin: 0px; border: 0px; overflow: hidden }
    .vid { position: fixed; width: 100%; height: 100%; }
    .img { position: fixed; width: 100%; height: 100%;
           background-size: contain; background-repeat: no-repeat; background-position: center; }
    .mqe { position: fixed; color: white; font-size: 120px;
           text-shadow: 5px 5px 1px #999999; -webkit-text-stroke: 1px #000; }
</style>
<script type="text/javascript"
    src="//www.gstatic.com/cast/sdk/libs/receiver/2.0.0/cast_receiver.js">
</script>
    <title>SIGNAGE</title>
  </head>
  <body>
<script type="text/javascript">
/*
  window.onload = function() {
    var dummy = document.createElement("video");
    cast.receiver.logger.setLevelValue(cast.receiver.LoggerLevel.DEBUG);
    window.mediaElement = dummy;
    window.mediaManager = new cast.receiver.MediaManager(window.mediaElement);
    window.castReceiverManager = cast.receiver.CastReceiverManager.getInstance();
    castReceiverManager.onSenderDisconnected = function (event) {
      console.log("sender disconnected");
    };
    castReceiverManager.start();
  };
*/
  var host = 'http://192.168.1.171';
  function sendReq(){
    var jsonp = document.createElement('script');
    jsonp.src = host + ':9000/?callback=getList';
    document.head.appendChild(jsonp);
// todo: if error
    document.head.removeChild(jsonp);
  }
  var mqe;
  var mediaQueue = [];
  function getList(files){
    var texts = [];
    var excludeTexts = [];
    files.forEach(function (file) {
      if (file.split(/\./).pop() == 'txt'){
        texts.push( file.substr(0, file.length - 4) );
      } else {
        excludeTexts.push(file);
      }
    });
    var str = texts.join('               ');
    if ( mqe && mqe.innerText != str ) {
      document.body.removeChild(mqe);
      delete mqe;
    }
    if ( str && ( (!mqe) || ( mqe.innerText != str ) ) ) {
      mqe = document.createElement('marquee');
      mqe.innerHTML = str;
      mqe.className = 'mqe';
      mqe.scrollamount = 20;
      document.body.appendChild(mqe);
    }
    mediaQueue = excludeTexts;
    mediaWorker();
  }
  var next, before, term;
  var watchTimer;
  function mediaWorker(){
    if (next){
      if (before) {
        document.body.replaceChild(next, before);
      } else {
        document.body.insertBefore(next, document.body.firstChild);
      }
      if (next.nodeName == 'VIDEO'){
        next.play();
        currentTime = next.currentTime;
        watchTimer = setInterval(watchDog, 10*1000);
      } else if (next.className == 'img') {
        setTimeout(mediaWorker, term * 1000);
      }
      before = next;
      next = null;
    }
// todo: clear dom
    if (mediaQueue.length > 0) {
      var media = mediaQueue.shift();
console.log(media);
      if (/\.(png|gif|jpe?g)$/.test(media)){
        next = document.createElement('div');
        next.style.backgroundImage = 'url(' + host + '/img/' + media + ')';
        next.className = 'img';
        var arr = media.split(/\./);
        if ( (arr[arr.length - 2]).match(/^[0-9]+$/) ) {
          term = 0 + arr[media.arr.length - 2];
        } else {
          term = 3;
        }
      } else if (/\.mp4$/.test(media)) {
        next = document.createElement('video');
        next.src = host + '/img/' + media;
        next.load();
        next.className = 'vid';
        next.addEventListener("error", function(e){
          clearInterval(watchTimer);
          watchTimer = null;
          mediaWorker();
        });
        next.addEventListener("ended", function(){
console.log(watchTimer, 'clear2');
          clearInterval(watchTimer);
          watchTimer = null;
          mediaWorker();
        });
      }
      if (! before){
        mediaWorker();
      }
    } else {
     sendReq();
    }
  }
  var currentTime;
  function watchDog(){
console.log('watch', currentTime, before.currentTime);
    if ( currentTime == before.currentTime) {
      console.log('mmm... ');
      before.load();
      before.play();
    }
    currentTime = before.currentTime;
  }
  sendReq();
</script>
  </body>
</html>

