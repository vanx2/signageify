<!DOCTYPE html>
<html>
  <head>
<style type="text/css">
  body { background-color: black; margin: 0px; border: 0px; overflow: hidden }
    #vid { position: fixed; width: 100%; height: 100%; display: none }
    #iid { position: fixed; width: 100%; height: 100%; display: none;
           background-size: contain; background-repeat: no-repeat; background-position: center; }
    #tid { position: fixed; width: 100%; height: 100%; color: white; font-size: 120px }
</style>
<script type="text/javascript"
    src="//www.gstatic.com/cast/sdk/libs/receiver/2.0.0/cast_receiver.js">
</script>
    <title>SIGNAGE</title>
  </head>
  <body>
  <video id='vid'></video>
  <div id='iid'></div>
  <marquee id='tid' scrollamount=20 >a</marquee>
<script type="text/javascript">
  var vid = document.getElementById('vid');
  var img = document.getElementById('iid');
  var txt = document.getElementById('tid');
  var host = 'http://192.168.1.171';

  window.onload = function() {
    cast.receiver.logger.setLevelValue(cast.receiver.LoggerLevel.DEBUG);
    window.mediaElement = vid;
    window.mediaManager = new cast.receiver.MediaManager(window.mediaElement);
    window.castReceiverManager = cast.receiver.CastReceiverManager.getInstance();
    castReceiverManager.onSenderDisconnected = function (event) {
      console.log("sender disconnected");
    };
    castReceiverManager.start();
  };

  var watchTimer;
  var currentTime;
  var mediaQueue = [];
  function sendReq(){
    var jsonp = document.createElement('script');
    jsonp.src = host + ':9000/?callback=getList';
    document.head.appendChild(jsonp);
// todo: if error
    document.head.removeChild(jsonp);
  }
  function getList(files){
    files.forEach(function (file) {
      tid.innerHTML = '';
      if ( /\.txt$/.test(file) ) {
        tid.innerHTML = tid.innerHTML + '      ' +
                        file.substr(0, file.length - 4);
      }
    });
    mediaQueue = files;
    mediaWorker();
  }
  function mediaWorker(){
    if ( mediaQueue.length > 0 ) {
      var media = mediaQueue.shift();
tid.innerHTML = media;
      if (/\.(png|gif|jpe?g)$/.test(media)){
        img.style.display = "block";
        img.style.backgroundImage = 'url(' + host + '/img/' + media + ')';
        var showSec = 1;
        var arr = media.split(/\./);
        if ( (arr[arr.length - 2]).match(/^[0-9]+$/) ) {
          showSec = 0 + arr[media.arr.length - 2];
        }
        setTimeout(mediaWorker, showSec*1000);
      } else if (/\.mp4$/.test(media)) {
        vid.src = 'https://192.168.1.171/' + media;
        img.style.display = "none";
        vid.style.display = "block";
        vid.load();
        vid.play();
// todo: if error
        watchTimer = setInterval(watchDog, 10*1000);
      } else {
        mediaWorker();
      }
    } else {
     sendReq();
    }
  }
  vid.addEventListener("error", function(e){tid.innerHTML = vid.error.code +
    vid.src;
  });
  vid.addEventListener("ended", function(){
    clearInterval(watchTimer);
    vid.style.display = "none";
    mediaWorker();
  });
  function watchDog(){
    if (! vid.ended) {
      if (vid.error){
        console.log('ERROR ', vid.error);
        vid.load();
        vid.play();
      }
      if(currentTime == vid.currentTime){
        vid.load();
        vid.play();
      }
      currentTime = vid.currentTime;
    }
  }
  sendReq();
</script>
  </body>
</html>

