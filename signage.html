<!DOCTYPE html>
<html>
  <head>
<style type="text/css">
  body { background-color: black; margin: 0px; border: 0px; overflow: hidden }
    .vid { position: fixed; width: 100%; height: 100%; }
    .img { position: fixed; width: 100%; height: 100%;
           background-size: contain; background-repeat: no-repeat; background-position: center; }
    .mqe { position: fixed; color: white; font-size: 120px;
           text-shadow: 5px 5px 1px #999999; -webkit-text-stroke: 1px #000; }
</style>
<script type="text/javascript"
    src="//www.gstatic.com/cast/sdk/libs/receiver/2.0.0/cast_receiver.js">
</script>
    <title>SIGNAGE</title>
  </head>
  <body>
<script type="text/javascript">
  var host = 'http://192.168.1.171';
  var mediaURL = host + '/img/';
  function sendReq(){
    var jsonp = document.createElement('script');
    jsonp.src = host + ':9000/?callback=getList';
    document.head.appendChild(jsonp);
// todo: if error
    document.head.removeChild(jsonp);
  }
  var mqe;
  var mediaContainer = {};
  var mediaQueue = [];
  function getList(files){
    for (item in mediaContainer){
      if ( files.indexOf(item) == -1) {
        delete mediaContainer[item];
      }
    }
    var texts = [];
    files.forEach(function (file) {
      if (file.split(/\./).pop() == 'txt'){
        texts.push( file.substr(0, file.length - 4) );
      } else if (/\.(png|gif|jpe?g)$/.test(file)){
        if (! mediaContainer.hasOwnProperty(file)){
          var imgE = document.createElement('div');
          imgE.style.backgroundImage = 'url(' + mediaURL + file + ')';
          imgE.className = 'img';
          imgE.id = file;
          mediaContainer[file] = imgE;
        }
        mediaQueue.push(file);
      } else if (/\.mp4$/.test(file)) {
        if (! mediaContainer.hasOwnProperty(file)){
          var vidE = document.createElement('video');
          vidE.src = mediaURL + file;
          vidE.load();
          vidE.className = 'vid';
          vidE.id = file;
          vidE.addEventListener("error", function(e){
            clearInterval(watchTimer);
            watchTimer = null;
            mediaWorker();
          });
          vidE.addEventListener("ended", function(){
            clearInterval(watchTimer);
            watchTimer = null;
            mediaWorker();
          });
          mediaContainer[file] = vidE;
        }
        mediaQueue.push(file);
      }
    });
    var str = texts.join(Array(30).join('&nbsp;'));
    if ( mqe && mqe.innerText != str ) {
      document.body.removeChild(mqe);
      delete mqe;
    }
    if ( str && ( (!mqe) || ( mqe.innerText != str ) ) ) {
      mqe = document.createElement('marquee');
      mqe.innerHTML = str;
      mqe.className = 'mqe';
      mqe.scrollAmount = 30;
      mqe.scrolldelay = 10;
      document.body.appendChild(mqe);
    }
    if(! before) {
      mediaWorker();
    }
  }
  var next, before;
  var watchTimer;
  function mediaWorker(){
    next = mediaContainer[mediaQueue.shift()];
    if (before) {
      document.body.replaceChild(next, before);
    } else {
      document.body.insertBefore(next, document.body.firstChild);
    }
    if (next.nodeName == 'VIDEO'){
      next.play();
      currentTime = next.currentTime;
      watchTimer = setInterval(watchDog, 20*1000);
    } else if (next.className == 'img') {
      var arr = next.id.split(/\./);
      setTimeout(mediaWorker, ( ( (arr[arr.length - 2]).match(/^[0-9]+$/) ) ?
                               ( 0 + arr[arr.length - 2] ) : 10 ) * 1000);
    }
    before = next;
    next = null;
    if (mediaQueue.length == 0){
      sendReq();
    }
  }
  var currentTime;
  function watchDog(){
console.log('watch', currentTime, before.currentTime);
    if ( currentTime == before.currentTime) {
      console.log('mmm... ');
      before.load();
      before.play();
    }
    currentTime = before.currentTime;
  }
  sendReq();
</script>
  </body>
</html>

